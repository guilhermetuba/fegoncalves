<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Vendas</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="container">
    <a href="index.html" class="link-button">Voltar para o Início</a>
    <h2>Consulta de Vendas</h2>

    <label for="periodo">Período:</label>
    <select id="periodo" onchange="atualizarDatas()">
      <option value="">Tudo</option>
      <option value="mes_atual">Mês Atual</option>
      <option value="mes_anterior">Mês Anterior</option>
      <option value="personalizado">Personalizado</option>
    </select><br><br>

    <div id="datasPersonalizadas" style="display: none;">
      <label for="dataInicio">Data Inicial:</label>
      <input type="date" id="dataInicio">

      <label for="dataFim">Data Final:</label>
      <input type="date" id="dataFim"><br><br>
    </div>

    <button onclick="aplicarFiltro()">Consultar</button>

    <div id="resultadoContainer" style="display: none; margin-top: 20px;">
      <h3>Resumo das Vendas</h3>
      <div id="resultadoResumo"></div>

      <h3>Resumo por Cliente</h3>
      <table id="tabelaClientes" border="1">
        <thead>
          <tr><th>Cliente</th><th>CPF</th><th>Total Comprado</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3>Resumo por Produto</h3>
      <table id="tabelaProdutos" border="1">
        <thead>
          <tr><th>Produto</th><th>Código</th><th>Total Vendido</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    function atualizarDatas() {
      const periodo = document.getElementById('periodo').value;
      const hoje = new Date();
      const inicioInput = document.getElementById('dataInicio');
      const fimInput = document.getElementById('dataFim');
      const datasBox = document.getElementById('datasPersonalizadas');

      if (periodo === 'personalizado') {
        datasBox.style.display = 'block';
        return;
      }

      datasBox.style.display = 'none';

      if (periodo === '') {
        inicioInput.value = '';
        fimInput.value = '';
        return;
      }

      let inicio, fim;

      if (periodo === 'mes_atual') {
        inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
      } else if (periodo === 'mes_anterior') {
        inicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
        fim = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
      }

      if (inicio && fim) {
        inicioInput.value = inicio.toISOString().split('T')[0];
        fimInput.value = fim.toISOString().split('T')[0];
      }
    }

    async function aplicarFiltro() {
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;

      let url = 'https://meu-backend-xi.vercel.app/api/registrar_venda?';
      if (dataInicio) url += `dataInicio=${dataInicio}&`;
      if (dataFim) url += `dataFim=${dataFim}&`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Erro ao buscar resumo');

        const resultado = await response.json();
        exibirResultado(resultado);
      } catch (error) {
        alert('Erro: ' + error.message);
      }
    }

   function exibirResultado(dados) {
  const container = document.getElementById('resultadoResumo');
  const totalValor = dados.total_valor || 0;
  const totalQtd = dados.total_quantidade || 0;

  let html = `
    <p><strong>Total de Vendas:</strong> ${totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
    <p><strong>Total de Itens Vendidos:</strong> ${totalQtd}</p>
  `;

  if (dados.resumoClientes) {
    html += `<h4>Resumo por Cliente</h4>
    <table>
      <tr><th>Cliente</th><th>Total Comprado</th></tr>
      ${Object.entries(dados.resumoClientes).sort((a,b) => b[1] - a[1])
        .map(([cliente, total]) =>
          `<tr><td>${cliente}</td><td>${total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td></tr>`
        ).join('')}
    </table>`;
  }

  if (dados.resumoProdutos) {
    html += `<h4>Resumo por Produto</h4>
    <table>
      <tr><th>Produto</th><th>Quantidade</th><th>Total Vendido</th></tr>
      ${Object.entries(dados.resumoProdutos)
        .sort((a,b) => b[1].total - a[1].total)
        .map(([produto, info]) =>
          `<tr><td>${produto}</td><td>${info.quantidade}</td><td>${info.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td></tr>`
        ).join('')}
    </table>`;
  }

  container.innerHTML = html;
  document.getElementById('resultadoContainer').style.display = 'block';
}

  </script>
</body>
</html>

