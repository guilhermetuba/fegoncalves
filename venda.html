<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venda</title>
       <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    label[for="detalhesProduto"] {
    margin-bottom: 15px; /* Aumenta o espaço abaixo do label */
    display: block; /* Garante que o label ocupe a largura total */
}
.campo-produto {
    display: flex;
    align-items: center; /* Alinha verticalmente */
    gap: 10px; /* Espaço entre os elementos */
    white-space: nowrap; /* Garante que o texto não quebre */
}
label[for="codigoProdutoInput"] {
    display: flex;
    align-items: center; /* Alinha verticalmente */
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap; /* Evita quebra de linha */
}
#codigoProdutoInput {
    height: 25px; /* Mantém a altura uniforme */
    padding: 5px;
    min-width: 100px; /* Tamanho adequado para não ficar muito pequeno */
    font-size: 14px;
}

#consultarProduto {
    height: 30px; /* Ajusta para alinhar com o input */
    padding: 5px 12px; /* Deixa o botão menor e ajustado */
    font-size: 14px;
    cursor: pointer;
}

#detalhesProduto {
    margin-top: 15px; /* Espaço acima da div de detalhes do produto */
}

    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
  width: 100%;
  padding: 10px;
  background: #6f42c1; /* Cor roxa */
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
button:hover {
  background: #5a32a3; /* Cor roxa mais escura ao passar o mouse */
}
.produtos-lista {
      margin-top: 20px;
    }
 .produtos-lista ul {
      list-style-type: none;
      padding: 0;
    }
.produtos-lista li {
    padding: 8px;
    background-color: #f1f1f1;
    margin-bottom: 5px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.produtos-lista li button {
    background-color: red !important; /* Forçando a cor vermelha */
    border: none;
    color: white;
    cursor: pointer;
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 4px;
    width: auto;
    margin-left: 10px;
}

.produtos-lista li button:hover {
    background-color: darkred !important; /* Forçando a cor de fundo mais escura ao passar o mouse */
}
    
          .excluir-produto {
    background-color: red;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 14px;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    padding: 0;
    margin-left: 10px;
    border-radius: 50%;
}


  #quantidadeProduto {
    width: 50px; /* Define uma largura menor */
    padding: 5px; /* Ajusta o preenchimento interno */
    text-align: center; /* Centraliza o número digitado */
    margin-left: 10px; /* Dá um pequeno espaço entre o label e o input */
}

.label-quantidade {
    display: inline-block; /* Mantém o label na mesma linha */
    font-weight: bold; /* Deixa o texto do label mais destacado */
}
          
.forma-pagamento-container {
  display: flex;
  align-items: center; /* Alinha verticalmente o label e o select */
}

label[for="formaPagamento"] {
  margin-right: 10px; /* Espaço entre o label e o select */
}

#formaPagamento {
  width: 150px; /* Ajuste o tamanho do select conforme necessário */
}
.desconto {
    margin: 10px 0;
}

.desconto-inputs {
    display: flex;
    gap: 10px;
}

.desconto-inputs input {
    width: 100px;
    padding: 5px;
    font-size: 1rem;
}
#totalVenda {
    font-size: 1.8rem;  /* Aumenta o tamanho */
    font-weight: bold;   /* Deixa em negrito */
    color: #0d47a1;      /* Azul escuro para destacar */
    background-color: #e3f2fd; /* Fundo azul claro */
    padding: 10px;       /* Espaçamento interno */
    border-radius: 8px;  /* Bordas arredondadas */
    display: inline-block;
    margin-top: 10px;
}

 hr {
      border: 0;
      border-top: 1px solid #ccc;
      margin-top: 30px;
    }
.link-button {
  display: block;
  text-align: center;
  color: #6f42c1;
  text-decoration: none;
  font-weight: bold;
}

.link-button:hover {
  text-decoration: underline;
}

/* Estilo específico só para o link de baixo */
.link-bottom {
  margin-top: 15px;
}

  </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="link-button">Voltar para o Início</a>
        <h2>Vendas</h2>
        <label for="dataVenda">Data da Venda:</label>
        <input type="text" id="dataVenda" name="dataVenda" required>
        <label for="cliente">Cliente</label>
      <select id="listaClientes" onchange="carregarProdutos()">
        <option value="">Selecione um Cliente...</option>
    </select>

    <label for="produto">Produto (Selecione ou digite o código)</label>
    <select id="listaProdutos" onchange="buscarProdutoPorSelect()">
        <option value="">Selecione um Produto...</option>
    </select>
    <div class="campo-produto">
    <label for="codigoProdutoInput">Código:  </label>
    <input type="text" id="codigoProdutoInput" placeholder="Digite o código">
    <button onclick="consultarProdutoPorCodigo()">Consultar</button>
    </div>
    <hr>
    <label for="detalhesProduto">Detalhes dos Produtos</label>
    <div id="detalhesProduto"></div>
    
     <label for="quantidadeProduto" class="label-quantidade">Quantidade:</label>
    <input type="number" id="quantidadeProduto" min="1" value="1">

    <button onclick="incluirProdutoNoCarrinho()">Incluir Produto no Carrinho</button>

    <label for="listaCarrinho">Carrinho</label>
    <ul id="listaCarrinho"></ul>

    <hr>
    <label for="subtotal">Subtotal: <span id="subtotal">R$ 0,00</span></label>

    <div class="forma-pagamento-container">
  <label for="formaPagamento">Forma de Pagamento:</label>
  <select id="formaPagamento">
    <option value="Pix">Pix</option>
    <option value="Cartão">Cartão</option>
    <option value="Dinheiro">Dinheiro</option>
  </select>
</div>
    <div class="desconto">
    <label for="descontos">Desconto</label>
    <div class="desconto-inputs">
       R$ <input type="text" id="desconto-reais" name="desconto-reais" inputmode="numeric" placeholder="R$ 0,00" oninput="aplicarMascaraMoeda(event), atualizarTotal()">
       ou <input type="text" id="desconto-percentual" name="desconto-percentual" placeholder="%" inputmode="numeric" oninput="aplicarMascaraMoeda(event),atualizarTotal()">
    %
    </div>
    </div>
    
    <label for="totalVenda"><strong>Total da Venda:</strong> <span id="totalVenda">R$ 0,00</span></p>

    <label for="condicoes">Condições</label>
    <select id="parcelas"></select>
    <p id="valorParcela"></p>

    <label id="descricaoDataPrimeiraParcela" for="dataPrimeiraParcela">Data 1ª Parcela</label>
    <input type="date" id="dataPrimeiraParcela">
        
    <button id="registrarVendaBtn" onclick="registrarVenda()">Confirmar Venda</button>
    <div id="loader" style="display: none; color: green; margin-top: 10px;">Registrando venda...</div>
     <a href="index.html" class="link-button link-bottom">Voltar para o Início</a>
    </div>
    
    <script>
// Limpa o carrinho ao carregar a página
    window.onload = function() {
    localStorage.removeItem("carrinho"); // Limpa o carrinho
    atualizarCarrinho(); // Atualiza o carrinho na interface
};

let carrinho = [];
let subtotal = 0;


async function incluirProdutoNoCarrinho() {
    console.log("Iniciando inclusão do produto no carrinho...");

    // Captura os detalhes do produto exibido na seção de detalhes
    let codigo = document.getElementById("detalhesProduto").querySelector("#campo_Código") ? 
                 document.getElementById("detalhesProduto").querySelector("#campo_Código").textContent.trim() : "";
    let nomeProduto = document.getElementById("detalhesProduto").querySelector("#campo_Produto") ? 
                      document.getElementById("detalhesProduto").querySelector("#campo_Produto").textContent.trim() : "";
    let preco = parseFloat(document.getElementById("detalhesProduto").querySelector("#campo_Preço") ? 
                           document.getElementById("detalhesProduto").querySelector("#campo_Preço").textContent.trim().replace("R$", "").trim().replace(",", ".") : 0);
    let quantidade = parseInt(document.getElementById("quantidadeProduto").value);

    console.log("Produto exibido nos detalhes:", { codigo, nomeProduto, preco, quantidade });

    // Valida se o código e a quantidade são válidos
    if (!codigo || !nomeProduto || isNaN(preco) || isNaN(quantidade) || quantidade <= 0) {
        console.error("Erro: Código, nome ou quantidade inválidos.");
        alert("Erro ao adicionar produto: Código, nome ou quantidade inválidos.");
        return;
    }

    // Criação do produto a ser adicionado ao carrinho
    let novoProduto = {
        codigo: codigo,
        produto: nomeProduto,
        quantidade: quantidade,
        preco: preco,
        total: quantidade * preco
    };

    console.log("Novo produto a ser adicionado:", novoProduto);

    // Adiciona ao carrinho no Local Storage
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    carrinho.push(novoProduto);
    localStorage.setItem("carrinho", JSON.stringify(carrinho));

    atualizarCarrinho();
}

function atualizarCarrinho() {
    console.log("Atualizando carrinho...");

    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    console.log("Carrinho carregado:", carrinho);

    let listaCarrinho = document.getElementById("listaCarrinho");
    if (!listaCarrinho) {
        console.error("Erro: Elemento 'listaCarrinho' não encontrado no DOM.");
        return;
    }

    listaCarrinho.innerHTML = ""; // Limpa a lista antes de atualizar

    let total = 0;

    carrinho.forEach((item, index) => {
        let li = document.createElement("li");
        li.textContent = `${item.produto} - ${item.quantidade}x (${item.preco.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}) = ${item.total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}`;

        let btnRemover = document.createElement("button");
        btnRemover.textContent = "X";
        btnRemover.classList.add("excluir-produto");
        btnRemover.onclick = function () {
            removerDoCarrinho(index);
        };

        li.appendChild(btnRemover);
        listaCarrinho.appendChild(li);

        total += item.total;
    });

    // Atualiza o subtotal no campo correspondente
    document.getElementById("subtotal").textContent = total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

    // Chama a função para atualizar o total
    atualizarTotal();

     console.log("Carrinho atualizado no DOM.");
}



        
 function atualizarTotal() {
    // Recupera o valor do subtotal exibido na tela
    let subtotal = parseFloat(document.getElementById("subtotal").textContent.replace("R$", "").replace(/\./g, "").replace(",", ".").trim()) || 0;
    let descontoReais = parseFloat(document.getElementById("desconto-reais").value.replace(",", ".")) || 0;
    // Recupera o desconto percentual e calcula o valor correspondente em reais
    let descontoPercentual = parseFloat(document.getElementById("desconto-percentual").value.replace(",", ".")) || 0;
    let descontoPorcentagemValor = (subtotal * descontoPercentual) / 100;
    // Soma os dois descontos
    let totalDesconto = descontoReais + descontoPorcentagemValor;
    // Calcula o total
    let total = subtotal - totalDesconto;
    // Evita valores negativos
    if (total < 0) total = 0;
    // Atualiza o total na tela
    document.getElementById("totalVenda").textContent = total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

     // Atualiza as opções de parcelamento
    atualizarCondicoes(total);
    
     console.log("Total atualizado:", total);
}



function removerDoCarrinho(index) {
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    let itemRemovido = carrinho.splice(index, 1)[0]; // Remove o item correto
    localStorage.setItem("carrinho", JSON.stringify(carrinho)); // Atualiza o carrinho no localStorage

    // Atualiza o carrinho na interface
    atualizarCarrinho();
}

      function atualizarCondicoes(total) {
    let selectCondicoes = document.getElementById("parcelas");
    selectCondicoes.innerHTML = "";

    // Adiciona a opção "À Vista"
    let optionAVista = document.createElement("option");
    optionAVista.value = "À Vista";
    optionAVista.textContent = `À Vista ${total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}`;
    selectCondicoes.appendChild(optionAVista);

    // Sempre adiciona a opção "1x"
    let option1x = document.createElement("option");
    option1x.value = 1;
    option1x.textContent = `1x de ${total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}`;
    selectCondicoes.appendChild(option1x);

    // Adiciona as opções de parcelamento, a partir de 2x
    let parcelasMaximas = Math.floor(total / 40); // Dividido por 40 para garantir o mínimo
    for (let i = 2; i <= parcelasMaximas; i++) {
        let valorParcela = total / i;
        if (valorParcela >= 40) {
            let option = document.createElement("option");
            option.value = i;
            option.textContent = `${i}x de ${valorParcela.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}`;
            selectCondicoes.appendChild(option);
        } else {
            break;
        }
    }
}

async function registrarVenda() {
  const btn = document.getElementById("registrarVendaBtn");
  const loader = document.getElementById("loader");

  // Ativa loader e desativa botão
  btn.disabled = true;
  loader.style.display = "block";

  const cpfCliente = document.getElementById("listaClientes").value;
  const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];

  if (!cpfCliente) {
    alert("Selecione um cliente antes de registrar a venda.");
    btn.disabled = false;
    loader.style.display = "none";
    return;
  }

  if (carrinho.length === 0) {
    alert("Adicione pelo menos um produto ao carrinho antes de registrar a venda.");
    btn.disabled = false;
    loader.style.display = "none";
    return;
  }

  try {
    // Consulta o estoque
    const respostaEstoque = await fetch('https://meu-backend-xi.vercel.app/api/consulta_produto');
    const dadosEstoque = await respostaEstoque.json();
    const estoque = dadosEstoque.estoque;

    // Verifica se todos os itens do carrinho têm quantidade suficiente no estoque
    for (const item of carrinho) {
      const produtoEstoque = estoque.find(p => String(p[0]).trim() === String(item.codigo).trim());

      if (!produtoEstoque) {
        alert(`Produto com código ${item.codigo} não encontrado no estoque.`);
        btn.disabled = false;
        loader.style.display = "none";
        return;
      }

      const nomeProduto = produtoEstoque[1];
      const quantidadeDisponivel = parseInt(produtoEstoque[4]);
      const quantidadeSolicitada = item.quantidade;

      if (quantidadeSolicitada > quantidadeDisponivel) {
        alert(`Estoque insuficiente para "${nomeProduto}".\nDisponível: ${quantidadeDisponivel}, Solicitado: ${quantidadeSolicitada}`);
        btn.disabled = false;
        loader.style.display = "none";
        return;
      }
    }

    const confirmacao = confirm("Tem certeza que deseja confirmar a venda?");
    if (!confirmacao) {
      btn.disabled = false;
      loader.style.display = "none";
      return;
    }

    const dataVenda = document.getElementById("dataVenda").value;
    const formaPagamento = document.getElementById("formaPagamento").value;
    const condicoes = document.getElementById("parcelas").value;
    const dataPrimeiraParcela = document.getElementById("dataPrimeiraParcela").value;
    let totalText = document.getElementById("totalVenda").textContent;
    totalText = totalText.replace("R$", "").trim().replace(",", ".");
    const totalVenda = parseFloat(totalText);

    // Envia os dados da venda
    const response = await fetch("https://meu-backend-xi.vercel.app/api/registrar_venda", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        dataVenda,
        cpfCliente,
        totalVenda,
        formaPagamento,
        condicoes,
      }),
    });

    const resultado = await response.json();
    const codigoVenda = resultado.codigoVenda;

    if (response.ok) {
      const itensVenda = carrinho.map(item => {
        return {
          codigoProduto: item.codigo,
          quantidade: item.quantidade,
          preco: parseFloat(item.preco),
          subtotal: parseFloat(item.preco) * parseInt(item.quantidade),
        };
      });

      // Registra itens da venda
      await fetch("https://meu-backend-xi.vercel.app/api/registrar_itens_venda", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ codigoVenda, cpfCliente, itens: itensVenda }),
      });

      // Registra as parcelas
      await fetch("https://meu-backend-xi.vercel.app/api/registrar_parcelas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          codigoVenda,
          cpfCliente,
          dataVenda,
          formaPagamento,
          condicoes,
          totalVenda,
          dataPrimeiraParcela
        }),
      });

      alert("Venda registrada com sucesso!");
      location.reload();
    } else {
      alert("Erro ao registrar a venda: " + resultado.message);
      btn.disabled = false;
      loader.style.display = "none";
    }

  } catch (error) {
    console.error("Erro ao registrar venda:", error);
    alert("Erro na conexão com o servidor.");
    btn.disabled = false;
    loader.style.display = "none";
  }
}
        

        
       function carregarClientes() {
    fetch("https://meu-backend-xi.vercel.app/api/consulta_cliente")
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (!data.clientes || data.clientes.length < 2) {
                console.error("Nenhum cliente encontrado.");
                return;
            }

            let clientes = data.clientes;

            // Ordena os clientes em ordem alfabética pelo nome
            clientes.sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR"));

            console.log(clientes);
            let select = document.getElementById("listaClientes");
            select.innerHTML = "<option value=''>Selecione um Cliente...</option>";

            clientes.forEach(cliente => {
                // Supondo que cada cliente tenha as propriedades "nome" e "cpf"
                if (cliente && cliente.nome && cliente.cpf) {
                    console.log("Cliente:", cliente.nome, "- CPF:", cliente.cpf);
                    let option = document.createElement("option");
                    option.value = cliente.cpf; // Armazena o CPF como valor
                    // Se quiser exibir nome e CPF juntos:
                    option.textContent = `${cliente.nome} - ${cliente.cpf}`;
                    select.appendChild(option);
                }
            });
        })
        .catch(error => console.error("Erro ao buscar clientes:", error));
}
  

       function carregarProdutos() {
    fetch("https://meu-backend-xi.vercel.app/api/consulta_produto")
        .then(response => response.json())
        .then(data => {
            if (!data.estoque || data.estoque.length < 2) {
                console.error("Nenhum produto encontrado.");
                return;
            }

            let produtos = data.estoque;

            // Ordena os produtos em ordem alfabética pelo nome
            produtos.sort((a, b) => a[1].localeCompare(b[1], "pt-BR"));

            let select = document.getElementById("listaProdutos");
            select.innerHTML = "<option value=''>Selecione um Produto...</option>";

            produtos.forEach(linha => {
                let codigo = linha[0];
                let nomeProduto = linha[1];
                if (codigo && nomeProduto) {
                    let option = document.createElement("option");
                    option.value = codigo;
                    option.textContent = nomeProduto;
                    select.appendChild(option);
                }
            });
        })
        .catch(error => console.error("Erro ao buscar produtos:", error));
}

        

        function buscarProdutoPorSelect() {
            let codigo = document.getElementById("listaProdutos").value;
            if (codigo) {
                buscarDetalhesProduto(codigo);
            }
        }

        function consultarProdutoPorCodigo() {
            let codigo = document.getElementById("codigoProdutoInput").value.trim();
            if (!codigo) {
                alert("Digite um código válido.");
                return;
            }
            buscarDetalhesProduto(codigo);
        }

        function buscarDetalhesProduto(codigo) {
    fetch(`${"https://meu-backend-xi.vercel.app/api/consulta_produto"}?produto=${encodeURIComponent(codigo)}`)
        .then(response => response.json())
        .then(data => {
            console.log("Resposta da API:", data); // Log da resposta

            if (data && data["Código"]) {
                let detalhesDiv = document.getElementById("detalhesProduto");
                detalhesDiv.innerHTML = "";

                let codigoProduto = data["Código"] || "Não encontrado";
                let nomeProduto = data["Produto"] || "Não encontrado";
                
                let precoVenda = data["Preço de Venda"] !== undefined ? data["Preço de Venda"].toString().replace(",", ".") : "0.00";
                precoVenda = parseFloat(precoVenda).toFixed(2);

                console.log("Valor original do preçoVenda:", precoVenda);

                if (!isNaN(precoVenda)) {
                    precoVenda = Number(precoVenda).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
                } else {
                    precoVenda = "R$ 0,00"; // Definindo um valor padrão caso seja inválido
                    console.error("Erro ao converter preço do produto:", data["Preço de Venda"]);
                }

                let camposExibidos = {
                    "Código": codigoProduto,
                    "Produto": nomeProduto,
                    "Preço": precoVenda
                };

                for (let chave in camposExibidos) {
                    let div = document.createElement("div");
                    div.innerHTML = `<strong>${chave}:</strong> <span id="campo_${chave}">${camposExibidos[chave]}</span>`;
                    detalhesDiv.appendChild(div);
                }
            } else {
                console.error("Erro ao buscar produto:", data);
                alert("Erro ao obter os detalhes do produto.");
            }
        })
        .catch(error => {
            console.error("Erro ao buscar produto:", error);
            alert("Erro ao buscar produto. Verifique o código e tente novamente.");
        });
}



    function aplicarMascaraMoeda(event) {
      var valor = event.target.value.replace(/\D/g, '');
      valor = valor.replace(/(\d)(\d{8})$/, '$1.$2');
      valor = valor.replace(/(\d)(\d{5})$/, '$1.$2');
      valor = valor.replace(/(\d)(\d{2})$/, '$1,$2');
      event.target.value = valor;
    }

        
  // Função para mostrar ou ocultar o campo e a descrição da Data 1ª Parcela
function atualizarCampoDataPrimeiraParcela() {
    let selectCondições = document.getElementById("parcelas");
    let dataPrimeiraParcela = document.getElementById("dataPrimeiraParcela");
    let descricaoDataPrimeiraParcela = document.getElementById("descricaoDataPrimeiraParcela");

    // Verifica se a condição selecionada é parcelada
    if (selectCondições.value && selectCondições.value !== "À Vista") {
        dataPrimeiraParcela.style.display = "block"; // Exibe o campo
        descricaoDataPrimeiraParcela.style.display = "block"; // Exibe a descrição
        preencherDataPrimeiraParcela(); // Preenche a data automaticamente
    } else {
        dataPrimeiraParcela.style.display = "none"; // Oculta o campo
        descricaoDataPrimeiraParcela.style.display = "none"; // Oculta a descrição
    }
}


function preencherDataPrimeiraParcela() {
  const dataVendaStr = document.getElementById("dataVenda").value; // dd/mm/yyyy
  const partes = dataVendaStr.split('/');

  if (partes.length !== 3) {
    console.error("Data de venda inválida.");
    return null;
  }

  const dia = parseInt(partes[0], 10);
  const mes = parseInt(partes[1], 10) - 1; // meses começam do 0
  const ano = parseInt(partes[2], 10);

  const dataVenda = new Date(ano, mes, dia);
  dataVenda.setMonth(dataVenda.getMonth() + 1); // adiciona 1 mês

  // Verifica se o mês virou, ex: 31/01 -> 03/03
  // Corrige para o último dia do mês anterior se necessário
  if (dataVenda.getDate() !== dia) {
    dataVenda.setDate(0); // último dia do mês anterior
  }

  // Retorna no formato dd/mm/yyyy
  const diaFormatado = String(dataVenda.getDate()).padStart(2, '0');
  const mesFormatado = String(dataVenda.getMonth() + 1).padStart(2, '0');
  const anoFormatado = dataVenda.getFullYear();

    // Define o valor do campo Data 1ª Parcela
    document.getElementById("dataPrimeiraParcela").value = `${anoFormatado}-${mesFormatado}-${diaFormatado}`;
}

// Chama a função para atualizar a visibilidade do campo ao carregar a página
document.getElementById("parcelas").addEventListener("change", atualizarCampoDataPrimeiraParcela);

// Chama a função inicial para garantir que o campo esteja correto ao carregar a página
atualizarCampoDataPrimeiraParcela();



        carregarClientes();
        
        document.addEventListener("DOMContentLoaded", function () {
    const dataInput = document.getElementById("dataVenda");

    // Preenche com data de hoje no formato dd/mm/yyyy
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = hoje.getFullYear();
    const hojeFormatado = `${dia}/${mes}/${ano}`;

    dataInput.value = hojeFormatado;

    // Máscara básica de data dd/mm/yyyy
    dataInput.addEventListener("input", function (e) {
      let valor = dataInput.value.replace(/\D/g, '');
      if (valor.length > 2) valor = valor.replace(/^(\d{2})(\d)/, "$1/$2");
      if (valor.length > 5) valor = valor.replace(/^(\d{2})\/(\d{2})(\d)/, "$1/$2/$3");
      dataInput.value = valor;
    });

    // Valida se não é data futura
    dataInput.addEventListener("blur", function () {
      const partes = dataInput.value.split('/');
      if (partes.length === 3) {
        const dia = parseInt(partes[0]);
        const mes = parseInt(partes[1]) - 1;
        const ano = parseInt(partes[2]);
        const dataSelecionada = new Date(ano, mes, dia);
        const hoje = new Date();

        if (dataSelecionada > hoje) {
          alert("A data da venda não pode ser futura.");
          dataInput.value = hojeFormatado;
        }
      }
    });
  });
    </script>

</body>
</html>
