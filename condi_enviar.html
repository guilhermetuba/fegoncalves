<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Condi</title>
 <link rel="stylesheet" href="estilos.css">
</head>
<body>
    <div class="container">
        <a href="index.html" class="link-button">Voltar para o Início</a>
        <h2>Condi</h2>
        <label for="dataCondi">Data do Condi:</label>
        <input type="text" id="dataCondi" name="dataCondi" required>
        <label for="cliente">Cliente</label>
      <select id="listaClientes" onchange="carregarProdutos()">
        <option value="">Selecione um Cliente...</option>
    </select>

    <label for="produto">Produto (Selecione ou digite o código)</label>
    <select id="listaProdutos" onchange="buscarProdutoPorSelect()">
        <option value="">Selecione um Produto...</option>
    </select>
    <div class="campo-produto">
    <label for="codigoProdutoInput">Código:  </label>
    <input type="text" id="codigoProdutoInput" placeholder="Digite o código">
    <button onclick="consultarProdutoPorCodigo()">Consultar</button>
    </div>
    <hr>
    <label for="detalhesProduto">Detalhes dos Produtos</label>
    <div id="detalhesProduto"></div>
    
     <label for="quantidadeProduto" class="label-quantidade">Quantidade:</label>
    <input type="number" id="quantidadeProduto" min="1" value="1">

    <button onclick="incluirProdutoNoCondi()">Incluir Produto no Condi</button>

    <div id="carrinhoContainer" style="display: none;">
  <h3>Produtos no Condi</h3>
  <div class="tabela-wrapper">
  <table id="tabelaCarrinho">
    <thead>
      <tr>
        <th>Código</th>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Preço Unitário</th>
        <th>Total</th>
        <th>Remover</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
</div>

    <hr>
    <label for="total">Total: <span id="total">R$ 0,00</span></label>
    <br>
    <button id="registrarCondiBtn">Registrar Condi</button>

      </div>

  <script>
    window.onload = function() {
    localStorage.removeItem("carrinho"); // Limpa o carrinho
    atualizarCarrinho(); // Atualiza o carrinho na interface
    const hoje = new Date().toLocaleDateString('pt-BR');
    document.getElementById("dataCondi").value = hoje;
};
    let carrinho = [];
    let total = 0;


    document.getElementById('registrarCondiBtn').addEventListener('click', async () => {
      const cpf = document.getElementById('listaClientes').value; 
      if (!cpf) {
    alert("Selecione um cliente antes de registrar o Condi");
    return;
  }
      
    carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
      
  if (carrinho.length === 0) {
    alert("Adicione pelo menos um produto ao carrinho antes de registrar o Condi");
     return;
  }
  const dataCondi = document.getElementById('dataCondi').value;
  carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
const registros = carrinho.map(item => ({
  data: dataCondi,
  cpf: cpf,
  codigoProduto: item.codigo,
  quantidade: item.quantidade
}));

  linhasProdutos.forEach(linha => {
    const codigoProduto = linha.querySelector('td:nth-child(1)').innerText;
    const quantidade = linha.querySelector('td:nth-child(2)').innerText;

    registros.push({
      data: dataCondi,
      cpf: cpf,
      codigoProduto: codigoProduto,
      quantidade: quantidade
    });
  });

  try {
    const resposta = await fetch('/registrar-condi', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ registros })
    });

    const resultado = await resposta.json();

    if (resposta.ok) {
      alert('Condições registradas com sucesso!');
    } else {
      alert('Erro ao registrar: ' + resultado.erro);
    }

  } catch (erro) {
    console.error('Erro ao enviar dados:', erro);
    alert('Erro ao registrar condições.');
  }
});  
    
    

    async function incluirProdutoNoCondi() {
    console.log("Iniciando inclusão do produto no Condi...");

    // Captura os detalhes do produto exibido na seção de detalhes
    let codigo = document.getElementById("detalhesProduto").querySelector("#campo_Código") ? 
                 document.getElementById("detalhesProduto").querySelector("#campo_Código").textContent.trim() : "";
    let nomeProduto = document.getElementById("detalhesProduto").querySelector("#campo_Produto") ? 
                      document.getElementById("detalhesProduto").querySelector("#campo_Produto").textContent.trim() : "";
    let preco = parseFloat(document.getElementById("detalhesProduto").querySelector("#campo_Preço") ? 
                           document.getElementById("detalhesProduto").querySelector("#campo_Preço").textContent.trim().replace("R$", "").trim().replace(",", ".") : 0);
    let quantidade = parseInt(document.getElementById("quantidadeProduto").value);

    console.log("Produto exibido nos detalhes:", { codigo, nomeProduto, preco, quantidade });

    // Valida se o código e a quantidade são válidos
    if (!codigo || !nomeProduto || isNaN(preco) || isNaN(quantidade) || quantidade <= 0) {
        console.error("Erro: Código, nome ou quantidade inválidos.");
        alert("Erro ao adicionar produto: Código, nome ou quantidade inválidos.");
        return;
    }

    // Criação do produto a ser adicionado ao carrinho
    let novoProduto = {
        codigo: codigo,
        produto: nomeProduto,
        quantidade: quantidade,
        preco: preco,
        total: quantidade * preco
    };

    console.log("Novo produto a ser adicionado:", novoProduto);

    // Adiciona ao carrinho no Local Storage
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    carrinho.push(novoProduto);
    localStorage.setItem("carrinho", JSON.stringify(carrinho));

    atualizarCarrinho();
}

 function atualizarCarrinho() {
  let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
  let container = document.getElementById("carrinhoContainer");
  let tbody = document.querySelector("#tabelaCarrinho tbody");
  let total = 0;

  if (carrinho.length === 0) {
    container.style.display = "none";
    tbody.innerHTML = "";
    document.getElementById("total").textContent = "R$ 0,00";
    return;
  }

  container.style.display = "block";
  tbody.innerHTML = "";

  carrinho.forEach((item, index) => {
    total += item.total;

    let row = document.createElement("tr");

    row.innerHTML = `
      <td>${item.codigo}</td>
      <td>${item.produto}</td>
      <td>${item.quantidade}</td>
      <td>${item.preco.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
      <td>${item.total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
      <td><button onclick="removerDoCarrinho(${index})" class="excluir-produto">X</button></td>
    `;

    tbody.appendChild(row);
  });

  document.getElementById("total").textContent = total.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });
}


    function removerDoCarrinho(index) {
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    let itemRemovido = carrinho.splice(index, 1)[0]; // Remove o item correto
    localStorage.setItem("carrinho", JSON.stringify(carrinho)); // Atualiza o carrinho no localStorage

    // Atualiza o carrinho na interface
    atualizarCarrinho();
}

      function carregarClientes() {
    fetch("https://meu-backend-xi.vercel.app/api/consulta_cliente")
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (!data.clientes || data.clientes.length < 2) {
                console.error("Nenhum cliente encontrado.");
                return;
            }

            let clientes = data.clientes;

            // Ordena os clientes em ordem alfabética pelo nome
            clientes.sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR"));

            console.log(clientes);
            let select = document.getElementById("listaClientes");
            select.innerHTML = "<option value=''>Selecione um Cliente...</option>";

            clientes.forEach(cliente => {
                // Supondo que cada cliente tenha as propriedades "nome" e "cpf"
                if (cliente && cliente.nome && cliente.cpf) {
                    console.log("Cliente:", cliente.nome, "- CPF:", cliente.cpf);
                    let option = document.createElement("option");
                    option.value = cliente.cpf; // Armazena o CPF como valor
                    // Se quiser exibir nome e CPF juntos:
                    option.textContent = `${cliente.nome} - ${cliente.cpf}`;
                    select.appendChild(option);
                }
            });
        })
        .catch(error => console.error("Erro ao buscar clientes:", error));
}
  

       function carregarProdutos() {
    fetch("https://meu-backend-xi.vercel.app/api/consulta_produto")
        .then(response => response.json())
        .then(data => {
            if (!data.estoque || data.estoque.length < 2) {
                console.error("Nenhum produto encontrado.");
                return;
            }

            let produtos = data.estoque;

            // Ordena os produtos em ordem alfabética pelo nome
            produtos.sort((a, b) => a[1].localeCompare(b[1], "pt-BR"));

            let select = document.getElementById("listaProdutos");
            select.innerHTML = "<option value=''>Selecione um Produto...</option>";

            produtos.forEach(linha => {
                let codigo = linha[0];
                let nomeProduto = linha[1];
                if (codigo && nomeProduto) {
                    let option = document.createElement("option");
                    option.value = codigo;
                    option.textContent = nomeProduto;
                    select.appendChild(option);
                }
            });
        })
        .catch(error => console.error("Erro ao buscar produtos:", error));
}

        

        function buscarProdutoPorSelect() {
            let codigo = document.getElementById("listaProdutos").value;
            if (codigo) {
                buscarDetalhesProduto(codigo);
            }
        }

        function consultarProdutoPorCodigo() {
            let codigo = document.getElementById("codigoProdutoInput").value.trim();
            if (!codigo) {
                alert("Digite um código válido.");
                return;
            }
            buscarDetalhesProduto(codigo);
        }

        function buscarDetalhesProduto(codigo) {
    fetch(`${"https://meu-backend-xi.vercel.app/api/consulta_produto"}?produto=${encodeURIComponent(codigo)}`)
        .then(response => response.json())
        .then(data => {
            console.log("Resposta da API:", data); // Log da resposta

            if (data && data["Código"]) {
                let detalhesDiv = document.getElementById("detalhesProduto");
                detalhesDiv.innerHTML = "";

                let codigoProduto = data["Código"] || "Não encontrado";
                let nomeProduto = data["Produto"] || "Não encontrado";
                
                let precoVenda = data["Preço de Venda"] !== undefined ? data["Preço de Venda"].toString().replace(",", ".") : "0.00";
                precoVenda = parseFloat(precoVenda).toFixed(2);

                console.log("Valor original do preçoVenda:", precoVenda);

                if (!isNaN(precoVenda)) {
                    precoVenda = Number(precoVenda).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
                } else {
                    precoVenda = "R$ 0,00"; // Definindo um valor padrão caso seja inválido
                    console.error("Erro ao converter preço do produto:", data["Preço de Venda"]);
                }

                let camposExibidos = {
                    "Código": codigoProduto,
                    "Produto": nomeProduto,
                    "Preço": precoVenda
                };

                for (let chave in camposExibidos) {
                    let div = document.createElement("div");
                    div.innerHTML = `<strong>${chave}:</strong> <span id="campo_${chave}">${camposExibidos[chave]}</span>`;
                    detalhesDiv.appendChild(div);
                }
            } else {
                console.error("Erro ao buscar produto:", data);
                alert("Erro ao obter os detalhes do produto.");
            }
        })
        .catch(error => {
            console.error("Erro ao buscar produto:", error);
            alert("Erro ao buscar produto. Verifique o código e tente novamente.");
        });
}

carregarClientes();



  </script>
</body>
</html>
