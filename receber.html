<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recebimentos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      width: 100%;
      padding: 10px;
      background: #6f42c1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #5a32a3;
    }
    .link-button {
      display: block;
      text-align: center;
      color: #6f42c1;
      text-decoration: none;
      font-weight: bold;
    }
    .link-button:hover {
      text-decoration: underline;
    }
    .link-bottom {
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <div class="container">
    <a href="index.html" class="link-button">Voltar para o Início</a>
    <h2>Recebimentos</h2>

    <form id="pagamentoForm">
      <label for="cliente">Cliente:</label>
      <select id="cliente" name="cliente" required>
        <option value="">Selecione um cliente</option>
        <!-- opções serão preenchidas via JavaScript -->
      </select>

      <label for="parcela">Parcelas em Aberto:</label>
      <select id="parcela" name="parcela" required>
        <option value="">Selecione uma parcela</option>
        <!-- opções serão preenchidas conforme o cliente -->
      </select>

      <label for="valor">Valor Recebido:</label>
      <input type="text" id="valorRecebido" />

      <label for="dataPagamento">Data do Pagamento:</label>
      <input type="date" id="dataPagamento" name="dataPagamento" required>

       <label for="observaoes">Observações:</label>
      <input type="text area" id="observacoes" name="observacoes">

      <button type="submit">Confirmar recebimento</button>
      <a href="index.html" class="link-button link-bottom">Voltar para o Início</a>
    </form>
  </div>

  <script>
    // Define a data atual no campo de data
const hoje = new Date();
hoje.setHours(0, 0, 0, 0); // Zera as horas, minutos, segundos e milissegundos

document.getElementById("dataPagamento").value = hoje.toISOString().split("T")[0];


    // Em breve: buscar clientes e parcelas via API ou Google Sheets
    async function carregarClientes() {
      try {
        const res = await fetch('https://meu-backend-xi.vercel.app/api/consulta_cliente');
        const { clientes } = await res.json();

        const selectCliente = document.getElementById("cliente");
        selectCliente.innerHTML = '<option value="">Selecione um cliente</option>';

        clientes.forEach(cliente => {
          const option = document.createElement("option");
          option.value = cliente.cpf; // agora o value é o CPF
          option.textContent = cliente.nome;
          selectCliente.appendChild(option);
        });

      } catch (error) {
        console.error("Erro ao carregar clientes:", error);
        alert("Erro ao carregar clientes.");
      }
    }

    function parseDataBR(dataStr) {
      const [dia, mes, ano] = dataStr.split("/");
      return new Date(`${ano}-${mes}-${dia}`);
    }

    // Armazena as parcelas para referência global
    let parcelas = [];

    carregarClientes();

    document.getElementById("cliente").addEventListener("change", async function () {
      const cpf = this.value;
      const selectParcela = document.getElementById("parcela");

      selectParcela.innerHTML = '<option value="">Carregando parcelas...</option>';

      if (!cpf) return;

      try {
        const res = await fetch(`https://meu-backend-xi.vercel.app/api/receber_parcelas?cpf=${cpf}`);
        const { parcelas: parcelasData } = await res.json();

        selectParcela.innerHTML = '<option value="">Selecione uma parcela</option>';

        if (!parcelasData || parcelasData.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "Nenhuma parcela em aberto";
          opt.disabled = true;
          selectParcela.appendChild(opt);
          return;
        }

        parcelas = parcelasData; // Atribui a resposta ao array de parcelas

        // Ordena as parcelas pela data de vencimento
        parcelas.sort((a, b) => parseDataBR(a.data_vencimento) - parseDataBR(b.data_vencimento));

        parcelas.forEach(p => {
          const option = document.createElement("option");
          const valorNumerico = parseFloat(p.valor?.toString().replace(",", ".")); 
          const valorFormatado = isNaN(valorNumerico) 
            ? "Valor inválido"
            : new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(valorNumerico);

          option.value = p.id || JSON.stringify(p); // usa ID ou JSON
          option.textContent = `${p.data_venda} - Venc: ${p.data_vencimento} - Parcela ${p.parcela} - ${valorFormatado}`;
          selectParcela.appendChild(option);
        });

      } catch (error) {
        console.error("Erro ao buscar parcelas:", error);
        selectParcela.innerHTML = '<option value="">Erro ao carregar parcelas</option>';
      }
    });

    // Quando o usuário escolhe uma parcela
    document.getElementById("parcela").addEventListener("change", () => {
      const selectedOption = document.getElementById("parcela").options[document.getElementById("parcela").selectedIndex];
      if (selectedOption && selectedOption.value) {
        const parcelaSelecionada = parcelas.find(p => (p.id || JSON.stringify(p)) === selectedOption.value);

        if (parcelaSelecionada) {
          // Guarda o valor da parcela para validação
          const valorParcelaAtual = parseFloat(parcelaSelecionada.valor?.toString().replace(",", ".")) || 0;

          // Preenche o campo com o valor da parcela
          document.getElementById("valorRecebido").value = valorParcelaAtual.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL"
          });
        }
      }
    });

    // Função para formatar valores como moeda
    function formatarComoMoeda(valor) {
      return valor.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
      });
    }

    // Máscara de moeda e validação do campo "Valor Recebido"
    document.getElementById("valorRecebido").addEventListener("input", () => {
      let inputValorRecebido = document.getElementById("valorRecebido");
      let raw = inputValorRecebido.value.replace(/\D/g, ""); // remove tudo que não é número
      let valor = parseFloat(raw) / 100; // converte para valor decimal

      // Atualiza o campo de valor recebido
      inputValorRecebido.value = formatarComoMoeda(valor);
    });

    document.getElementById("pagamentoForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const cliente = document.getElementById("cliente").value;
      const parcela = document.getElementById("parcela").value;
      const valor = parseFloat(document.getElementById("valorRecebido").value.replace("R$", "").replace(",", ".")); 
      const dataPagamento = document.getElementById("dataPagamento").value;

      if (!cliente || !parcela || isNaN(valor) || !dataPagamento) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      // Aqui vai a lógica de atualização da aba Contas a Receber
      console.log("Registrando pagamento de", valor, "na parcela", parcela, "do cliente", cliente, "na data", dataPagamento);

      alert("Pagamento registrado (simulado). Em breve integrará com o backend!");
    });
  </script>

</body>
</html>
